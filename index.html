<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯çµ¡ç°¿ç”¢ç”Ÿå™¨ - LIFEå¸«ç‰¹è£½ç‰ˆ</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 15px;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container { display: flex; gap: 15px; width: 100%; max-width: 1600px; margin: 0 auto; box-sizing: border-box; flex: 1; }
        
        /* ä¸Šæ–¹åˆ†é èˆ‡åŠŸèƒ½åˆ— */
        .tabs-container { width: 100%; max-width: 1600px; margin: 0 auto 15px auto; display: flex; gap: 10px; border-bottom: 2px solid #bdc3c7; padding-bottom: 10px; align-items: center; flex-wrap: wrap; box-sizing: border-box; }
        .tab-btn { padding: 8px 16px; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 1rem; margin-bottom: -12px; }
        .tab-btn.active { background: #fff; border-bottom: 2px solid #fff; font-weight: bold; color: #2980b9; }
        
        .action-btn { padding: 6px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-green { background: #27ae60; } .btn-green:hover { background: #2ecc71; }
        .btn-orange { background: #f39c12; } .btn-orange:hover { background: #f1c40f; }
        .btn-red { background: #e74c3c; } .btn-red:hover { background: #c0392b; }
        .btn-blue { background: #3498db; } .btn-blue:hover { background: #2980b9; }
        
        .export-group { margin-left: auto; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .export-btn { padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .export-btn:hover { background: #2c3e50; }

        /* å·¦å´ä¸»é¢æ¿ */
        .main-panel { flex: 1; min-width: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; transition: all 0.3s ease; }
        .header-section { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .header-section input, .header-section select { font-size: 1rem; padding: 4px; }
        .days-container { display: flex; gap: 10px; flex: 1; overflow-x: auto; }
        .day-card { flex: 1 1 0; min-width: 180px; border: 1px solid #ccc; border-radius: 5px; padding: 10px; background-color: #fafafa; display: flex; flex-direction: column; }
        .date-display { font-size: 0.95rem; font-weight: bold; color: #2c3e50; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #aaa; min-height: 22px; }
        .holiday-mark { color: #e74c3c; font-size: 0.85rem; display: block; margin-top: 2px; }
        .morning-group { display: flex; align-items: center; margin-bottom: 8px; }
        .section-title { font-weight: bold; color: #2980b9; white-space: nowrap; }
        .morning-input { flex: 1; min-width: 0; border: none; border-bottom: 1px dashed #aaa; background: transparent; font-size: 1rem; padding: 2px 5px; font-family: inherit; }
        .morning-input:focus { outline: none; border-bottom: 1px solid #3498db; background-color: #f0f8ff; }
        
        .task-list { width: 100%; flex: 1; min-height: 350px; border: 1px dashed #ccc; padding: 8px; box-sizing: border-box; font-family: inherit; font-size: 1rem; line-height: 1.6; overflow-y: auto; background-color: white; }
        .task-list:focus { outline: 2px solid #3498db; background-color: #f0f8ff; }

        /* å³å´é¢æ¿åŒ…è£å™¨ */
        .side-wrapper { position: relative; display: flex; align-items: flex-start; }
        .collapse-toggle { position: absolute; left: -22px; top: 15px; background: #2c3e50; color: white; border: none; width: 22px; height: 40px; border-radius: 5px 0 0 5px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .collapse-toggle:hover { background: #34495e; }

        /* å³å´å¿«æ·é¢æ¿ */
        .side-panel { width: 220px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease; overflow: hidden; }
        .side-panel.collapsed { width: 0; padding-left: 0; padding-right: 0; opacity: 0; border: none; }

        .tool-section { margin-bottom: 20px; }
        .tool-section h3 { border-bottom: 2px solid #2c3e50; padding-bottom: 5px; margin-top: 0; font-size: 1rem; }
        
        /* ç·¨è¼¯å™¨å·¥å…·åˆ— */
        .editor-tools { display: flex; flex-wrap: nowrap; gap: 2px; margin-bottom: 10px; align-items: center; justify-content: space-between; }
        .editor-tools button { border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; border-radius: 3px; padding: 2px 5px; height: 26px; font-size: 0.9rem; flex-shrink: 0; }
        .editor-tools select { border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; border-radius: 3px; padding: 0 2px; height: 26px; font-size: 0.85rem; flex-shrink: 1; min-width: 50px; }
        .editor-tools button:hover { background: #e0e0e0; }
        
        .color-group { display: flex; gap: 3px; width: 100%; margin-top: 5px; align-items: center; font-size: 0.8rem; flex-wrap: nowrap; }
        .color-swatch { width: 18px; height: 18px; border-radius: 3px; border: 1px solid #aaa; cursor: pointer; display: inline-block; flex-shrink: 0; padding: 0; }
        .color-swatch:hover { transform: scale(1.1); }
        .clear-bg-btn { font-size: 0.75rem; padding: 0 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 3px; white-space: nowrap; height: 18px; }
        .custom-color-btn { position: relative; overflow: hidden; width: 18px; height: 18px; border-radius: 3px; border: 1px solid #aaa; cursor: pointer; background: conic-gradient(red, yellow, green, cyan, blue, magenta, red); display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; padding: 0; }
        .custom-color-btn input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; padding: 0; margin: 0; }

        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
        .quick-btn { background-color: #ecf0f1; border: 1px solid #bdc3c7; padding: 3px 0; border-radius: 4px; cursor: pointer; font-size: 0.9rem; text-align: center; width: 100%; box-sizing: border-box; }
        .quick-btn:hover { background-color: #d5dbdb; }
        
        .delete-mode .quick-btn { background-color: #ffeaea; border-color: #e74c3c; color: #c0392b; position: relative; }
        .delete-mode .quick-btn::after { content: 'âœ–'; position: absolute; top: -6px; right: -4px; background: #e74c3c; color: white; border-radius: 50%; width: 14px; height: 14px; font-size: 10px; line-height: 14px; text-align: center; }
        .toggle-delete-btn { width: 100%; background-color: #95a5a6; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; margin-bottom: 12px; font-size: 0.9rem; }
        .toggle-delete-btn.active { background-color: #e74c3c; }

        .add-custom { display: flex; gap: 5px; }
        .add-custom input { flex: 1; padding: 3px; min-width: 0; font-size: 0.9rem; }
        .add-custom button { background-color: #3498db; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; }

        .footer { text-align: center; margin-top: 20px; font-size: 0.9rem; color: #7f8c8d; padding-top: 10px; border-top: 1px dashed #ccc; }

        /* åˆ—å°ç”¨æ¨£å¼ */
        #print-all-container { display: none; }
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background-color: white; padding: 0; }
            .tabs-container, .side-wrapper, .header-section, .footer { display: none !important; }
            body:not(.print-all-mode) .container { display: block; width: 100%; max-width: none; margin: 0; }
            body.print-all-mode .container { display: none !important; }
            body.print-all-mode #print-all-container { display: block; width: 100%; }
            .main-panel, .print-panel { box-shadow: none; padding: 0; border: none; display: block; margin-bottom: 20px; }
            .print-panel { page-break-after: always; }
            .print-panel:last-child { page-break-after: auto; }
            .days-container { display: flex; gap: 5px; }
            .day-card { border: 1px solid #000; break-inside: avoid; background-color: white; flex: 1; min-width: 0; }
            .task-list { border: none; overflow: hidden; height: auto; min-height: 400px; resize: none; background-color: white; }
            .morning-input, .morning-print-div { border: none !important; border-bottom: 1px solid #000 !important; font-family: inherit; font-size: 1rem; width: 100%; display: block; min-height: 22px; }
            
            /* ä¿®æ­£é é¦–ï¼šé¡¯ç¤ºå¤§æ¨™é¡Œèˆ‡é€±æ¬¡ */
            .main-panel::before, .print-panel::before { 
                content: "è¯çµ¡ç°¿ç”¢ç”Ÿå™¨\A" attr(data-print-title); 
                white-space: pre-wrap; display: block; font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 15px; line-height: 1.4;
            }
        }
    </style>
</head>
<body>

<div class="tabs-container" id="tabs-container"></div>

<div class="container">
    <div class="main-panel" id="main-panel">
        <div class="header-section">
            <label>é¡¯ç¤ºå¤©æ•¸ï¼š</label>
            <select id="display-days" onchange="changeDisplayDays()">
                <option value="1">1 å¤©</option><option value="2">2 å¤©</option><option value="3">3 å¤©</option>
                <option value="4">4 å¤©</option><option value="5" selected>5 å¤©</option>
                <option value="6">6 å¤©</option><option value="7">7 å¤©</option>
            </select>
            
            <label style="margin-left:10px;">é€±æ¬¡åç¨±ï¼š</label>
            <input type="text" id="week-name" style="width: 100px;" onchange="autoSave()">
            
            <label style="margin-left:10px;">èµ·å§‹æ—¥æœŸï¼š</label>
            <input type="date" id="start-date" onchange="calculateDates()">
        </div>
        
        <div class="days-container" id="days-container"></div>
    </div>

    <div class="side-wrapper">
        <button class="collapse-toggle" id="collapse-btn" onclick="toggleSidePanel()">â–¶</button>
        
        <div class="side-panel" id="side-panel">
            <button id="toggle-delete-btn" class="toggle-delete-btn" onclick="toggleDeleteMode()">âœï¸ ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•</button>
            
            <div class="tool-section">
                <h3>å­—é«”èˆ‡é¡è‰²ç·¨è¼¯</h3>
                <div class="editor-tools">
                    <button onmousedown="event.preventDefault();" onclick="execCmd('undo')" title="å¾©åŸ">â†©ï¸</button>
                    <button onmousedown="event.preventDefault();" onclick="execCmd('redo')" title="é‡è¤‡">â†ªï¸</button>
                    <button onmousedown="event.preventDefault();" onclick="execCmd('bold')" title="ç²—é«”"><b>B</b></button>
                    <button onmousedown="event.preventDefault();" onclick="execCmd('italic')" title="æ–œé«”"><i>I</i></button>
                    <button onmousedown="event.preventDefault();" onclick="execCmd('underline')" title="åº•ç·š"><u>U</u></button>
                    <select onmousedown="event.preventDefault();" onchange="execCmd('fontSize', this.value)" title="å­—é«”å¤§å°">
                        <option value="2">å°</option>
                        <option value="3" selected>æ¨™æº–</option>
                        <option value="4">åŠ å¤§</option>
                        <option value="5">ç‰¹å¤§</option>
                    </select>
                </div>
                <div class="color-group">
                    æ–‡å­—ï¼š
                    <button type="button" class="color-swatch" style="background:#000000;" onmousedown="event.preventDefault();" onclick="execCmd('foreColor', '#000000')" title="é»‘"></button>
                    <button type="button" class="color-swatch" style="background:#e74c3c;" onmousedown="event.preventDefault();" onclick="execCmd('foreColor', '#e74c3c')" title="ç´…"></button>
                    <button type="button" class="color-swatch" style="background:#2980b9;" onmousedown="event.preventDefault();" onclick="execCmd('foreColor', '#2980b9')" title="è—"></button>
                    <button type="button" class="color-swatch" style="background:#27ae60;" onmousedown="event.preventDefault();" onclick="execCmd('foreColor', '#27ae60')" title="ç¶ "></button>
                    <label class="custom-color-btn" title="è‡ªè¨‚é¡è‰²"><input type="color" onchange="execCmd('foreColor', this.value)"></label>
                </div>
                <div class="color-group">
                    åº•è‰²ï¼š
                    <button type="button" class="color-swatch" style="background:#f1c40f;" onmousedown="event.preventDefault();" onclick="execCmd('backColor', '#f1c40f')" title="é»ƒ"></button>
                    <button type="button" class="color-swatch" style="background:#2ecc71;" onmousedown="event.preventDefault();" onclick="execCmd('backColor', '#2ecc71')" title="ç¶ "></button>
                    <button type="button" class="color-swatch" style="background:#00ffff;" onmousedown="event.preventDefault();" onclick="execCmd('backColor', '#00ffff')" title="é’"></button>
                    <button type="button" class="clear-bg-btn" onmousedown="event.preventDefault();" onclick="execCmd('backColor', 'transparent')">ç„¡åº•è‰²</button>
                    <label class="custom-color-btn" title="è‡ªè¨‚åº•è‰²"><input type="color" onchange="execCmd('backColor', this.value)"></label>
                </div>
            </div>

            <div class="tool-section">
                <h3>å‹•ä½œé¸é …</h3>
                <div class="btn-grid" id="action-btns-container"></div>
                <div class="add-custom">
                    <input type="text" id="new-action" placeholder="ä¾‹ï¼šèƒŒ">
                    <button onclick="addBtn('action')">æ–°å¢</button>
                </div>
            </div>

            <div class="tool-section">
                <h3>ä½œæ¥­é …ç›®</h3>
                <div class="btn-grid" id="hw-btns-container"></div>
                <div class="add-custom">
                    <input type="text" id="new-hw" placeholder="ä¾‹ï¼šé€ è©æœ¬">
                    <button onclick="addBtn('hw')">æ–°å¢</button>
                </div>
            </div>
            
            <div style="font-size: 0.8rem; color: #7f8c8d; line-height: 1.4; border-top: 1px dashed #ccc; padding-top: 10px;">
                ğŸ’¡ <b>æ›è¡ŒæŠ€å·§ï¼š</b><br>æŒ‰ <b>Shift+Enter</b> å¯æ’å…¥å°é½Šå¥½çš„ç©ºè¡Œã€‚
            </div>
        </div>
    </div>
</div>

<div id="print-all-container"></div>

<div class="footer">
    ç‰ˆæ¬Šæ‰€æœ‰ &copy; 2026 è¯çµ¡ç°¿ç”¢ç”Ÿå™¨ï½œè¨­è¨ˆè€…ï¼š<b>LIFEå¸«</b>
</div>

<input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(event)">

<script>
    let appData = [];
    let currentTabIndex = 0;
    let displayDaysCount = 5;
    const weekdayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    
    const holidays = {
        "01-01": "å…ƒæ—¦", "02-27": "å’Œå¹³ç´€å¿µæ—¥è£œå‡", "02-28": "å’Œå¹³ç´€å¿µæ—¥", "04-04": "å…’ç«¥ç¯€", 
        "04-05": "æ¸…æ˜ç¯€", "05-01": "å‹å‹•ç¯€", "10-10": "åœ‹æ…¶æ—¥"
    };

    let isPanelOpen = true;
    function toggleSidePanel() {
        const panel = document.getElementById('side-panel');
        const btn = document.getElementById('collapse-btn');
        isPanelOpen = !isPanelOpen;
        if (isPanelOpen) { panel.classList.remove('collapsed'); btn.innerText = 'â–¶'; } 
        else { panel.classList.add('collapsed'); btn.innerText = 'â—€'; }
    }

    function execCmd(command, value = null) {
        if(lastFocusedElement) { lastFocusedElement.focus(); }
        document.execCommand(command, false, value);
        autoSave();
    }

    let isDeleteMode = false;
    const defaultActionBtns = ['è€ƒ', 'è¨‚ç°½', 'äº¤', 'å¸¶', '()', 'P.', 'ã€', 'ï½', 'â¤ï¸'];
    const defaultHwBtns = ['åœ‹ç¿’', 'åœ‹é‡', 'æ•¸ç¿’', 'æ•¸é‡', 'ç”Ÿç”²', 'ç”Ÿä¹™', 'ç¤¾ç¿’', 'ç¤¾é‡', 'é ç¿’å–®', 'æˆé€ å–®', 'è½å¯«', 'åœ‹å·', 'æ•¸å·', 'ç¤¾å·'];
    let actionBtns = JSON.parse(localStorage.getItem('myActionBtns')) || defaultActionBtns;
    let hwBtns = JSON.parse(localStorage.getItem('myHwBtns')) || defaultHwBtns;

    window.onload = function() { loadData(); renderButtons(); };

    function renderButtons() {
        const actionContainer = document.getElementById('action-btns-container');
        const hwContainer = document.getElementById('hw-btns-container');
        
        actionContainer.innerHTML = actionBtns.map((text, index) => 
            `<button class="quick-btn" onclick="handleBtnClick('action', ${index})">${text}</button>`
        ).join('');
        
        hwContainer.innerHTML = hwBtns.map((text, index) => 
            `<button class="quick-btn" onclick="handleBtnClick('hw', ${index})">${text}</button>`
        ).join('');

        actionContainer.className = isDeleteMode ? "btn-grid delete-mode" : "btn-grid";
        hwContainer.className = isDeleteMode ? "btn-grid delete-mode" : "btn-grid";
    }

    function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        const btn = document.getElementById('toggle-delete-btn');
        btn.className = isDeleteMode ? "toggle-delete-btn active" : "toggle-delete-btn";
        btn.innerText = isDeleteMode ? "âœ… å®Œæˆåˆªé™¤ (é»æ“Šé€€å‡º)" : "âœï¸ ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•";
        renderButtons();
    }

    function handleBtnClick(type, index) {
        if (isDeleteMode) {
            if (type === 'action') { actionBtns.splice(index, 1); localStorage.setItem('myActionBtns', JSON.stringify(actionBtns)); } 
            else { hwBtns.splice(index, 1); localStorage.setItem('myHwBtns', JSON.stringify(hwBtns)); }
            renderButtons();
        } else {
            const text = type === 'action' ? actionBtns[index] : hwBtns[index];
            insertText(text);
        }
    }

    function addBtn(type) {
        const inputId = type === 'action' ? 'new-action' : 'new-hw';
        const val = document.getElementById(inputId).value.trim();
        if (!val) return;
        if (type === 'action') { actionBtns.push(val); localStorage.setItem('myActionBtns', JSON.stringify(actionBtns)); } 
        else { hwBtns.push(val); localStorage.setItem('myHwBtns', JSON.stringify(hwBtns)); }
        document.getElementById(inputId).value = '';
        renderButtons();
    }

    function loadData() {
        const savedData = localStorage.getItem('teacherContactBook');
        if (savedData) {
            appData = JSON.parse(savedData);
        } else {
            addNewWeekLogic();
            return; 
        }
        renderTabs();
        renderCurrentWeek();
    }

    function autoSave() {
        if (appData.length === 0) return;
        let week = appData[currentTabIndex];
        week.weekName = document.getElementById('week-name').value;
        week.startDate = document.getElementById('start-date').value;
        
        for (let i = 0; i < displayDaysCount; i++) {
            const taskArea = document.getElementById(`day-content-${i}`);
            const morningInput = document.getElementById(`morning-content-${i}`);
            if (taskArea) week.contents[i] = taskArea.innerHTML; 
            if (morningInput) week.morningContents[i] = morningInput.value;
        }
        localStorage.setItem('teacherContactBook', JSON.stringify(appData));
        renderTabs();
    }

    function clearCurrentWeek() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬é€±æ‰€æœ‰çš„å…§å®¹å—ï¼Ÿ')) {
            appData[currentTabIndex].contents = Array(7).fill("( ) 1. <br>( ) 2. <br>( ) 3. ");
            appData[currentTabIndex].morningContents = Array(7).fill("");
            renderCurrentWeek();
            autoSave(); 
        }
    }

    function deleteCurrentWeek() {
        if(confirm('âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦ã€Œåˆªé™¤ã€é€™ä¸€æ•´é€±å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼')) {
            appData.splice(currentTabIndex, 1);
            if(appData.length === 0) addNewWeekLogic();
            else { currentTabIndex = Math.max(0, currentTabIndex - 1); autoSave(); renderTabs(); renderCurrentWeek(); }
        }
    }

    function changeDisplayDays() {
        displayDaysCount = parseInt(document.getElementById('display-days').value, 10);
        renderCurrentWeek();
    }

    function renderTabs() {
        const container = document.getElementById('tabs-container');
        container.innerHTML = ''; 

        const tabsDiv = document.createElement('div');
        tabsDiv.style.display = 'flex'; tabsDiv.style.flexWrap = 'wrap'; tabsDiv.style.gap = '5px';
        appData.forEach((week, index) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${index === currentTabIndex ? 'active' : ''}`;
            btn.innerText = week.weekName || `ç¬¬ ${index + 1} é€±`;
            btn.onclick = () => switchTab(index);
            tabsDiv.appendChild(btn);
        });
        container.appendChild(tabsDiv);

        const exportGroup = document.createElement('div');
        exportGroup.className = 'export-group';
        
        exportGroup.innerHTML = `
            <button class="action-btn btn-blue" onclick="exportData()" title="ä¸‹è¼‰å‚™ä»½æª”">ğŸ’¾ å‚™ä»½</button>
            <button class="action-btn btn-blue" onclick="document.getElementById('import-file').click()" title="è¼‰å…¥å‚™ä»½æª”">ğŸ“‚ è¼‰å…¥</button>
            <div style="width: 1px; height: 20px; background: #aaa; margin: 0 5px;"></div>
            <button class="action-btn btn-orange" onclick="addNewWeekLogic()">â• æ–°å¢ä¸€é€±</button>
            <button class="action-btn btn-red" onclick="deleteCurrentWeek()">ğŸ—‘ï¸ åˆªé™¤æ­¤é€±</button>
            <button class="action-btn btn-green" onclick="clearCurrentWeek()">ğŸ§¹ æ¸…ç©ºå…§å®¹</button>
            <button class="export-btn" onclick="printPage()">ğŸ–¨ï¸ åˆ—å°/PDF</button>
            <button class="export-btn" onclick="exportWord()" style="background:#2980b9;">ğŸ“„ åŒ¯å‡ºWord</button>
        `;
        container.appendChild(exportGroup);
    }

    function switchTab(index) { autoSave(); currentTabIndex = index; renderTabs(); renderCurrentWeek(); }

    function addNewWeekLogic() {
        autoSave(); 
        
        let nextWeekName = "ç¬¬ 1 é€±";
        let nextStartDate = "";
        
        if (appData.length > 0) {
            let lastWeek = appData[appData.length - 1];
            let match = lastWeek.weekName.match(/ç¬¬\s*(\d+)\s*é€±/);
            if (match) {
                nextWeekName = `ç¬¬ ${parseInt(match[1], 10) + 1} é€±`;
            } else {
                nextWeekName = `ç¬¬ ${appData.length + 1} é€±`;
            }
            
            if (lastWeek.startDate) {
                let parts = lastWeek.startDate.split('-');
                if(parts.length === 3) {
                    let d = new Date(parts[0], parts[1] - 1, parts[2]);
                    d.setDate(d.getDate() + 7);
                    let yyyy = d.getFullYear();
                    let mm = String(d.getMonth() + 1).padStart(2, '0');
                    let dd = String(d.getDate()).padStart(2, '0');
                    nextStartDate = `${yyyy}-${mm}-${dd}`;
                }
            }
        }
        
        appData.push({
            weekName: nextWeekName, startDate: nextStartDate,
            morningContents: Array(7).fill(""),
            contents: Array(7).fill("( ) 1. <br>( ) 2. <br>( ) 3. ")
        });
        currentTabIndex = appData.length - 1;
        autoSave(); renderTabs(); renderCurrentWeek();
    }

    function renderCurrentWeek() {
        const week = appData[currentTabIndex];
        document.getElementById('week-name').value = week.weekName;
        document.getElementById('start-date').value = week.startDate;
        document.getElementById('display-days').value = displayDaysCount;
        
        // å°‡é€±æ¬¡åç¨±å¯«å…¥å±¬æ€§ï¼Œä¾›åˆ—å°ä½¿ç”¨
        document.getElementById('main-panel').setAttribute('data-print-title', week.weekName);

        const daysContainer = document.getElementById('days-container');
        daysContainer.innerHTML = '';
        
        let startDateObj = null;
        if (week.startDate) {
            let parts = week.startDate.split('-');
            if(parts.length === 3) startDateObj = new Date(parts[0], parts[1] - 1, parts[2]);
        }

        for (let i = 0; i < displayDaysCount; i++) {
            let dateString = "è«‹è¨­å®šèµ·å§‹æ—¥"; let holidayString = "";
            if (startDateObj) {
                let currentDate = new Date(startDateObj);
                currentDate.setDate(currentDate.getDate() + i);
                let mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                let dd = String(currentDate.getDate()).padStart(2, '0');
                let dayOfWeek = weekdayNames[currentDate.getDay()]; 
                dateString = `${mm}æœˆ${dd}æ—¥ ${dayOfWeek}`;

                let checkHoliday = `${mm}-${dd}`;
                if (holidays[checkHoliday]) holidayString = `<span class="holiday-mark">(${holidays[checkHoliday]})</span>`;
            }

            let safeMorning = week.morningContents[i] || '';
            let safeContent = week.contents[i] || '( ) 1. <br>( ) 2. <br>( ) 3. ';

            const dayHTML = `
                <div class="day-card">
                    <div class="date-display" id="date-text-${i}">${dateString}${holidayString}</div>
                    <div class="morning-group">
                        <span class="section-title">æ—©ï¼š</span>
                        <input type="text" class="morning-input focus-target" id="morning-content-${i}" oninput="autoSave()" value="${safeMorning}">
                    </div>
                    <div class="task-list focus-target" id="day-content-${i}" contenteditable="true" oninput="autoSave()" onblur="autoSave()">${safeContent}</div>
                </div>
            `;
            daysContainer.insertAdjacentHTML('beforeend', dayHTML);
        }

        document.querySelectorAll('.focus-target').forEach(elem => {
            elem.addEventListener('focus', function() { lastFocusedElement = this; });
            if(elem.hasAttribute('contenteditable')) elem.addEventListener('keydown', handleRichTextEnter);
        });
    }

    function calculateDates() { autoSave(); renderCurrentWeek(); }

    function handleRichTextEnter(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const sel = window.getSelection();
            const node = sel.focusNode;
            
            if (e.shiftKey) {
                document.execCommand('insertHTML', false, '<br>ã€€ã€€');
            } else {
                const text = node.textContent;
                const match = text.match(/^\s*\(\s*\)\s*(\d+)\.\s*/);
                if (match) {
                    const nextNum = parseInt(match[1], 10) + 1;
                    document.execCommand('insertHTML', false, `<br>( ) ${nextNum}. `);
                } else {
                    document.execCommand('insertHTML', false, '<br>');
                }
            }
        }
    }

    let lastFocusedElement = null;

    function insertText(text) {
        if (!lastFocusedElement) return alert('è«‹å…ˆé»é¸å·¦å´è¦è¼¸å…¥çš„æ¬„ä½å–”ï¼');
        lastFocusedElement.focus();
        
        if (lastFocusedElement.tagName === 'INPUT') {
            const start = lastFocusedElement.selectionStart;
            const end = lastFocusedElement.selectionEnd;
            const value = lastFocusedElement.value;
            lastFocusedElement.value = value.substring(0, start) + text + value.substring(end);
            lastFocusedElement.selectionStart = lastFocusedElement.selectionEnd = start + text.length;
        } else if (lastFocusedElement.hasAttribute('contenteditable')) {
            document.execCommand('insertHTML', false, text);
        }
        autoSave(); 
    }

    function exportData() {
        autoSave();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "LIFEå¸«è¯çµ¡ç°¿å‚™ä»½.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if(Array.isArray(importedData)){
                    appData = importedData;
                    localStorage.setItem('teacherContactBook', JSON.stringify(appData));
                    currentTabIndex = 0;
                    renderTabs(); renderCurrentWeek();
                    alert("âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼");
                } else { throw new Error("Format Error"); }
            } catch (err) { alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè¼‰å…¥å¤±æ•—ï¼"); }
            event.target.value = ''; 
        };
        reader.readAsText(file);
    }

    function printPage() { 
        autoSave();
        let doPrintAll = confirm("æŒ‰ã€ç¢ºå®šã€‘åˆ—å°æˆ–åŒ¯å‡ºã€Œæ‰€æœ‰é€±æ¬¡ã€\n\næŒ‰ã€å–æ¶ˆã€‘åƒ…åˆ—å°ã€Œç•¶å‰é é¢ (æœ¬é€±)ã€");
        
        if (doPrintAll) {
            document.body.classList.add('print-all-mode');
            let container = document.getElementById('print-all-container');
            container.innerHTML = '';
            
            appData.forEach((week) => {
                let html = generatePrintHtmlForWeek(week);
                container.innerHTML += html;
            });
            window.print();
            document.body.classList.remove('print-all-mode');
        } else {
            window.print(); 
        }
    }

    function generatePrintHtmlForWeek(week) {
        let startDateObj = null;
        if (week.startDate) {
            let parts = week.startDate.split('-');
            if(parts.length === 3) startDateObj = new Date(parts[0], parts[1] - 1, parts[2]);
        }
        
        let daysHtml = '';
        for (let i = 0; i < displayDaysCount; i++) {
            let dateString = "è«‹è¨­å®šèµ·å§‹æ—¥"; let holidayString = "";
            if (startDateObj) {
                let d = new Date(startDateObj); d.setDate(d.getDate() + i);
                let mm = String(d.getMonth()+1).padStart(2,'0');
                let dd = String(d.getDate()).padStart(2,'0');
                dateString = `${mm}æœˆ${dd}æ—¥ ${weekdayNames[d.getDay()]}`;
                let checkHoliday = `${mm}-${dd}`;
                if (holidays[checkHoliday]) holidayString = `<span class="holiday-mark">(${holidays[checkHoliday]})</span>`;
            }
            let safeMorning = week.morningContents[i] || '';
            let safeContent = week.contents[i] || '( ) 1. <br>( ) 2. <br>( ) 3. ';
            
            daysHtml += `
                <div class="day-card">
                    <div class="date-display">${dateString}${holidayString}</div>
                    <div class="morning-group">
                        <span class="section-title">æ—©ï¼š</span>
                        <div class="morning-print-div">${safeMorning}</div>
                    </div>
                    <div class="task-list" style="border:none;">${safeContent}</div>
                </div>
            `;
        }
        return `
            <div class="print-panel" data-print-title="${week.weekName}">
                <div class="days-container">${daysHtml}</div>
            </div>
        `;
    }

    function exportWord() {
        autoSave();
        let exportAll = confirm("æŒ‰ã€ç¢ºå®šã€‘åŒ¯å‡ºã€Œæ‰€æœ‰é€±æ¬¡ã€è‡³Word\n\næŒ‰ã€å–æ¶ˆã€‘åƒ…åŒ¯å‡ºã€Œç•¶å‰é é¢ (æœ¬é€±)ã€");
        let weeksToExport = exportAll ? appData : [appData[currentTabIndex]];
        
        let html = `<html xmlns:w="urn:schemas-microsoft-com:office:word"><head><meta charset="utf-8"><title>è¯çµ¡ç°¿</title></head><body>`;
        
        weeksToExport.forEach((week, index) => {
            html += `<h2 style="text-align:center;">è¯çµ¡ç°¿ç”¢ç”Ÿå™¨</h2>`;
            html += `<h3 style="text-align:center;">${week.weekName}</h3>`;
            html += `<table border="1" style="width:100%; border-collapse:collapse; text-align:left;" cellpadding="10"><tr>`;
            
            let startDateObj = null;
            if (week.startDate) {
                let parts = week.startDate.split('-');
                if(parts.length === 3) startDateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            }

            for (let i = 0; i < displayDaysCount; i++) {
                let dateText = "è«‹è¨­å®šèµ·å§‹æ—¥";
                if(startDateObj) {
                    let d = new Date(startDateObj); d.setDate(d.getDate() + i);
                    let mm = String(d.getMonth()+1).padStart(2,'0');
                    let dd = String(d.getDate()).padStart(2,'0');
                    dateText = `${mm}æœˆ${dd}æ—¥ ${weekdayNames[d.getDay()]}`;
                }
                html += `<th style="background-color:#f2f2f2; width:${100/displayDaysCount}%;">${dateText}</th>`;
            }
            html += `</tr><tr>`;
            for (let i = 0; i < displayDaysCount; i++) {
                let morning = week.morningContents[i] || '';
                let content = week.contents[i] || '';
                html += `<td style="vertical-align:top;"><p><b>æ—©è‡ªç¿’ï¼š</b>${morning}</p><div>${content}</div></td>`;
            }
            html += `</tr></table>`;
            
            if(index < weeksToExport.length - 1) {
                html += `<br clear=all style='mso-special-character:line-break;page-break-before:always'>`;
            }
        });
        html += `</body></html>`;
        
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = exportAll ? `è¯çµ¡ç°¿_å…¨éƒ¨é€±æ¬¡.doc` : `${weeksToExport[0].weekName}_è¯çµ¡ç°¿.doc`;
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }
</script>

</body>

</html>
